"use strict";(self.webpackChunkjeongyong_park_github_io=self.webpackChunkjeongyong_park_github_io||[]).push([["5934"],{9198:function(n,e,r){r.r(e),r.d(e,{assets:function(){return i},contentTitle:function(){return s},default:function(){return h},frontMatter:function(){return o},metadata:function(){return l},toc:function(){return c}});var l=r(1642),a=r(5893),t=r(65);let o={title:"C#\uC5D0\uC11C Thread\uC640 Parallel.ForEach \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uB294 \uBC29\uBC95",date:"2017-01-09",description:"C#\uC5D0\uC11C Thread \uB0B4\uBD80\uC758 Parallel.ForEach \uC791\uC5C5\uC744 \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uB294 \uBC29\uBC95\uACFC \uD604\uB300\uC801\uC778 \uBE44\uB3D9\uAE30 \uD328\uD134\uC744 \uC18C\uAC1C\uD569\uB2C8\uB2E4.",authors:["jypark"],tags:["dotnet","csharp","threading","parallel"],image:"csharp.png",slug:"csharp-thread-parallel-foreach-cancellation",hide_table_of_contents:!1},s=void 0,i={authorsImageUrls:[void 0]},c=[{value:"Thread.Abort()\uB97C \uC0AC\uC6A9\uD558\uBA74 \uC548 \uB418\uB294 \uC774\uC720:",id:"threadabort\uB97C-\uC0AC\uC6A9\uD558\uBA74-\uC548-\uB418\uB294-\uC774\uC720",level:3},{value:"\uD83C\uDFAF \uD575\uC2EC \uAC1C\uB150",id:"-\uD575\uC2EC-\uAC1C\uB150",level:2},{value:"\uD83D\uDCDD \uB808\uAC70\uC2DC \uCF54\uB4DC (\uCC38\uACE0\uC6A9 - \uC0AC\uC6A9 \uAE08\uC9C0)",id:"-\uB808\uAC70\uC2DC-\uCF54\uB4DC-\uCC38\uACE0\uC6A9---\uC0AC\uC6A9-\uAE08\uC9C0",level:2},{value:"\u2705 \uD604\uB300\uC801\uC774\uACE0 \uC548\uC804\uD55C \uBC29\uBC95",id:"-\uD604\uB300\uC801\uC774\uACE0-\uC548\uC804\uD55C-\uBC29\uBC95",level:2},{value:"1. CancellationToken\uC744 \uC0AC\uC6A9\uD55C \uC548\uC804\uD55C \uC911\uB2E8",id:"1-cancellationtoken\uC744-\uC0AC\uC6A9\uD55C-\uC548\uC804\uD55C-\uC911\uB2E8",level:3},{value:"2. WPF/WinForms\uC5D0\uC11C \uC0AC\uC6A9\uD558\uB294 \uBC29\uBC95",id:"2-wpfwinforms\uC5D0\uC11C-\uC0AC\uC6A9\uD558\uB294-\uBC29\uBC95",level:3},{value:"3. \uC9C4\uD589\uB960 \uBCF4\uACE0\uAC00 \uD3EC\uD568\uB41C \uACE0\uAE09 \uBC84\uC804",id:"3-\uC9C4\uD589\uB960-\uBCF4\uACE0\uAC00-\uD3EC\uD568\uB41C-\uACE0\uAE09-\uBC84\uC804",level:3},{value:"4. \uC0AC\uC6A9 \uC608\uC81C (\uCF58\uC194 \uC560\uD50C\uB9AC\uCF00\uC774\uC158)",id:"4-\uC0AC\uC6A9-\uC608\uC81C-\uCF58\uC194-\uC560\uD50C\uB9AC\uCF00\uC774\uC158",level:3},{value:"\uD83D\uDD27 \uC131\uB2A5 \uCD5C\uC801\uD654 \uD301",id:"-\uC131\uB2A5-\uCD5C\uC801\uD654-\uD301",level:2},{value:"1. \uC801\uC808\uD55C \uBCD1\uB82C\uB3C4 \uC124\uC815",id:"1-\uC801\uC808\uD55C-\uBCD1\uB82C\uB3C4-\uC124\uC815",level:3},{value:"2. \uC801\uC808\uD55C \uBC30\uCE58 \uD06C\uAE30 \uC120\uD0DD",id:"2-\uC801\uC808\uD55C-\uBC30\uCE58-\uD06C\uAE30-\uC120\uD0DD",level:3},{value:"3. \uBA54\uBAA8\uB9AC \uC0AC\uC6A9\uB7C9 \uCD5C\uC801\uD654",id:"3-\uBA54\uBAA8\uB9AC-\uC0AC\uC6A9\uB7C9-\uCD5C\uC801\uD654",level:3},{value:"\uD83D\uDCDA \uCD94\uAC00 \uD559\uC2B5 \uC790\uB8CC",id:"-\uCD94\uAC00-\uD559\uC2B5-\uC790\uB8CC",level:2},{value:"\uAD8C\uC7A5 \uC77D\uAE30 \uC790\uB8CC:",id:"\uAD8C\uC7A5-\uC77D\uAE30-\uC790\uB8CC",level:3},{value:"\uAD00\uB828 \uD328\uD134:",id:"\uAD00\uB828-\uD328\uD134",level:3},{value:"\uD83C\uDFAF \uACB0\uB860",id:"-\uACB0\uB860",level:2},{value:"\uD575\uC2EC \uC694\uC57D",id:"\uD575\uC2EC-\uC694\uC57D",level:3}];function d(n){let e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...n.components},{Details:r}=e;return r||function(n,e){throw Error("Expected "+(e?"component":"object")+" `"+n+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.p,{children:"GUI \uD658\uACBD\uC5D0\uC11C \uBC84\uD2BC \uD074\uB9AD\uACFC \uAC19\uC740 \uC774\uBCA4\uD2B8\uB85C \uC2DC\uAC04\uC774 \uC624\uB798 \uAC78\uB9AC\uB294 \uC791\uC5C5\uC744 \uC2E4\uD589\uD560 \uB54C, UI \uC2A4\uB808\uB4DC\uC640 \uBD84\uB9AC\uD558\uC5EC \uAC1C\uBC1C\uD558\uB294 \uAC83\uC740 C#\uBFD0\uB9CC \uC544\uB2C8\uB77C \uBAA8\uB4E0 GUI \uD504\uB808\uC784\uC6CC\uD06C\uC5D0\uC11C \uAE30\uBCF8\uC801\uC778 \uD328\uD134\uC785\uB2C8\uB2E4."}),"\n",(0,a.jsx)(e.p,{children:'\uC2DC\uAC04\uC774 \uC624\uB798 \uAC78\uB9AC\uB294 \uC791\uC5C5\uC744 \uB354\uC6B1 \uBE60\uB974\uAC8C \uCC98\uB9AC\uD558\uACE0 \uC2F6\uB2E4\uBA74 \uBCD1\uB82C \uCC98\uB9AC\uAC00 \uAC00\uC7A5 \uD6A8\uACFC\uC801\uC778 \uBC29\uBC95 \uC911 \uD558\uB098\uC785\uB2C8\uB2E4. \uD558\uC9C0\uB9CC "\uC791\uC5C5\uC744 \uB3C4\uC911\uC5D0 \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uACE0 \uC2F6\uB2E4"\uB294 \uC694\uAD6C\uC0AC\uD56D\uC774 \uC0DD\uAE30\uBA74\uC11C \uBCF5\uC7A1\uD55C \uBB38\uC81C\uAC00 \uBC1C\uC0DD\uD569\uB2C8\uB2E4.'}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.strong,{children:"TL;DR"}),": Thread.Abort()\uB294 \uC704\uD5D8\uD558\uBBC0\uB85C \uC0AC\uC6A9\uD558\uC9C0 \uB9C8\uC138\uC694. \uB300\uC2E0 CancellationToken\uACFC Task \uAE30\uBC18 \uBE44\uB3D9\uAE30 \uD328\uD134\uC744 \uC0AC\uC6A9\uD558\uC5EC \uC548\uC804\uD558\uAC8C \uBCD1\uB82C \uC791\uC5C5\uC744 \uC911\uB2E8\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4."]}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"\uC774 \uAE00\uC5D0\uC11C\uB294 Thread \uB0B4\uBD80\uC758 Parallel.ForEach \uC791\uC5C5\uC744 \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uB294 \uBC29\uBC95\uACFC \uD604\uB300\uC801\uC778 \uBE44\uB3D9\uAE30 \uD328\uD134\uC744 \uC18C\uAC1C\uD569\uB2C8\uB2E4."}),"\n",(0,a.jsxs)(e.admonition,{title:"Thread.Abort() \uC0AC\uC6A9 \uAE08\uC9C0",type:"danger",children:[(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.strong,{children:"\uC911\uC694"}),": \uC774 \uAE00\uC758 \uC6D0\uBCF8 \uCF54\uB4DC\uB294 2017\uB144\uC5D0 \uC791\uC131\uB418\uC5C8\uC73C\uBA70, ",(0,a.jsx)(e.code,{children:"Thread.Abort()"})," \uC0AC\uC6A9\uC744 \uD3EC\uD568\uD558\uACE0 \uC788\uC2B5\uB2C8\uB2E4."]}),(0,a.jsxs)(e.p,{children:["\uC774 \uBC29\uBC95\uC740 \uD604\uC7AC ",(0,a.jsx)(e.strong,{children:"\uAD8C\uC7A5\uB418\uC9C0 \uC54A\uC73C\uBA70"}),", .NET Core/.NET 5+ \uC5D0\uC11C\uB294 ",(0,a.jsx)(e.strong,{children:"\uC9C0\uC6D0\uB418\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4"}),"."]}),(0,a.jsxs)(e.p,{children:["\uC774 \uAE00\uC5D0\uC11C\uB294 ",(0,a.jsx)(e.strong,{children:"CancellationToken"}),"\uACFC ",(0,a.jsx)(e.strong,{children:"Task \uAE30\uBC18 \uBE44\uB3D9\uAE30 \uD328\uD134"}),"\uC744 \uC0AC\uC6A9\uD55C \uC548\uC804\uD55C \uBC29\uBC95\uC744 \uC81C\uC2DC\uD569\uB2C8\uB2E4."]})]}),"\n",(0,a.jsx)(e.h3,{id:"threadabort\uB97C-\uC0AC\uC6A9\uD558\uBA74-\uC548-\uB418\uB294-\uC774\uC720",children:"Thread.Abort()\uB97C \uC0AC\uC6A9\uD558\uBA74 \uC548 \uB418\uB294 \uC774\uC720:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"\uB370\uC774\uD130 \uC190\uC0C1"}),": \uC791\uC5C5 \uC911\uC778 \uB370\uC774\uD130\uAC00 \uBD88\uC644\uC804\uD55C \uC0C1\uD0DC\uB85C \uB0A8\uC744 \uC218 \uC788\uC74C"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"\uB9AC\uC18C\uC2A4 \uB204\uC218"}),": \uD30C\uC77C \uD578\uB4E4, \uB124\uD2B8\uC6CC\uD06C \uC5F0\uACB0 \uB4F1\uC774 \uC81C\uB300\uB85C \uD574\uC81C\uB418\uC9C0 \uC54A\uC744 \uC218 \uC788\uC74C"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"\uC608\uCE21 \uBD88\uAC00\uB2A5\uD55C \uB3D9\uC791"}),": \uC5B8\uC81C \uC5B4\uB514\uC11C \uC911\uB2E8\uB420\uC9C0 \uC608\uCE21\uD560 \uC218 \uC5C6\uC74C"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:".NET Core \uBBF8\uC9C0\uC6D0"}),": .NET Core/.NET 5+ \uC5D0\uC11C\uB294 ",(0,a.jsx)(e.code,{children:"PlatformNotSupportedException"})," \uBC1C\uC0DD"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"-\uD575\uC2EC-\uAC1C\uB150",children:"\uD83C\uDFAF \uD575\uC2EC \uAC1C\uB150"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"CancellationToken"}),": .NET\uC5D0\uC11C \uAD8C\uC7A5\uD558\uB294 \uC548\uC804\uD55C \uC791\uC5C5 \uC911\uB2E8 \uBA54\uCEE4\uB2C8\uC998"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Task"}),": Thread\uBCF4\uB2E4 \uD604\uB300\uC801\uC774\uACE0 \uC548\uC804\uD55C \uBE44\uB3D9\uAE30 \uC791\uC5C5 \uB2E8\uC704"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Parallel.ForEach"}),": CPU \uC9D1\uC57D\uC801 \uC791\uC5C5\uC758 \uBCD1\uB82C \uCC98\uB9AC"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"ConfigureAwait"}),": UI \uC2A4\uB808\uB4DC \uB370\uB4DC\uB77D \uBC29\uC9C0"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"-\uB808\uAC70\uC2DC-\uCF54\uB4DC-\uCC38\uACE0\uC6A9---\uC0AC\uC6A9-\uAE08\uC9C0",children:"\uD83D\uDCDD \uB808\uAC70\uC2DC \uCF54\uB4DC (\uCC38\uACE0\uC6A9 - \uC0AC\uC6A9 \uAE08\uC9C0)"}),"\n",(0,a.jsxs)(e.p,{children:["\uB2E4\uC74C\uC740 \uC6D0\uBCF8 \uAE00\uC758 \uCF54\uB4DC\uC785\uB2C8\uB2E4. ",(0,a.jsx)(e.strong,{children:"\uC2E4\uC81C \uD504\uB85C\uC81D\uD2B8\uC5D0\uC11C\uB294 \uC0AC\uC6A9\uD558\uC9C0 \uB9C8\uC138\uC694"}),":"]}),"\n",(0,a.jsxs)(r,{children:[(0,a.jsx)("summary",{children:"\uB808\uAC70\uC2DC \uCF54\uB4DC \uBCF4\uAE30 (Thread.Abort \uC0AC\uC6A9 - \uAD8C\uC7A5\uD558\uC9C0 \uC54A\uC74C)"}),(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:'// \u274C \uC798\uBABB\uB41C \uBC29\uBC95 - Thread.Abort() \uC0AC\uC6A9\npublic class LegacyExample\n{\n    public void BadExample()\n    {\n        var canceler = new RulyCanceler();\n        var worker = new TestFilter(10000000);\n\n        Thread t = new Thread(() =>\n        {\n            try\n            {\n                worker.execute(canceler);\n            }\n            catch(OperationCanceledException)\n            {\n                Console.WriteLine("Canceled!");\n            }\n        });\n        \n        t.Start();\n        Console.ReadKey();\n        \n        // \u274C \uC704\uD5D8\uD55C \uBC29\uBC95\n        canceler.Cancel();\n        t.Abort();  // .NET Core\uC5D0\uC11C \uC9C0\uC6D0\uB418\uC9C0 \uC54A\uC74C\n        t.Join();\n    }\n}\n\npublic class RulyCanceler\n{\n    private readonly object _cancelLocker = new object();\n    private bool _cancelRequest;\n    \n    public bool IsCancellationRequested\n    {\n        get { lock (_cancelLocker) return _cancelRequest; }\n    }\n\n    public void Cancel() { lock (_cancelLocker) _cancelRequest = true; }\n\n    public void ThrowIfCancellationRequested()\n    {\n        if (IsCancellationRequested) throw new OperationCanceledException();\n    }\n}\n'})})]}),"\n",(0,a.jsx)(e.h2,{id:"-\uD604\uB300\uC801\uC774\uACE0-\uC548\uC804\uD55C-\uBC29\uBC95",children:"\u2705 \uD604\uB300\uC801\uC774\uACE0 \uC548\uC804\uD55C \uBC29\uBC95"}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.strong,{children:"CancellationToken"}),"\uC744 \uC0AC\uC6A9\uD558\uC5EC \uC548\uC804\uD558\uACE0 \uC608\uCE21 \uAC00\uB2A5\uD55C \uC791\uC5C5 \uC911\uB2E8\uC744 \uAD6C\uD604\uD558\uC138\uC694."]}),"\n",(0,a.jsx)(e.h3,{id:"1-cancellationtoken\uC744-\uC0AC\uC6A9\uD55C-\uC548\uC804\uD55C-\uC911\uB2E8",children:"1. CancellationToken\uC744 \uC0AC\uC6A9\uD55C \uC548\uC804\uD55C \uC911\uB2E8"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:'using System;\nusing System.Collections.Concurrent;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace ModernThreadingExample\n{\n    public class SafeParallelProcessor\n    {\n        public async Task ProcessDataAsync(long itemCount, CancellationToken cancellationToken = default)\n        {\n            const int batchSize = 1000;\n            var partitioner = Partitioner.Create(0, itemCount, batchSize);\n            \n            // ParallelOptions\uB97C \uC0AC\uC6A9\uD558\uC5EC CancellationToken \uC804\uB2EC\n            var parallelOptions = new ParallelOptions\n            {\n                CancellationToken = cancellationToken,\n                MaxDegreeOfParallelism = Environment.ProcessorCount\n            };\n\n            try\n            {\n                await Task.Run(() =>\n                {\n                    Parallel.ForEach(partitioner, parallelOptions, (range, state) =>\n                    {\n                        for (long i = range.Item1; i < range.Item2; i++)\n                        {\n                            // \uC8FC\uAE30\uC801\uC73C\uB85C \uCDE8\uC18C \uC694\uCCAD \uD655\uC778\n                            cancellationToken.ThrowIfCancellationRequested();\n                            \n                            // \uC2E4\uC81C \uC791\uC5C5 \uC218\uD589\n                            ProcessSingleItem(i);\n                            \n                            // \uC120\uD0DD\uC0AC\uD56D: \uC9C4\uD589\uB960 \uBCF4\uACE0\n                            ReportProgress(i, itemCount);\n                        }\n                    });\n                }, cancellationToken);\n            }\n            catch (OperationCanceledException)\n            {\n                Console.WriteLine("\uC791\uC5C5\uC774 \uCDE8\uC18C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.");\n                throw; // \uD638\uCD9C\uC790\uC5D0\uAC8C \uCDE8\uC18C \uC0C1\uD0DC \uC804\uB2EC\n            }\n        }\n\n        private void ProcessSingleItem(long index)\n        {\n            // \uC2E4\uC81C \uC791\uC5C5 \uB85C\uC9C1\n            Console.WriteLine($"Processing item {index}");\n            \n            // \uC2DC\uBBAC\uB808\uC774\uC158\uC744 \uC704\uD55C \uC9C0\uC5F0\n            Thread.Sleep(10);\n        }\n        \n        private void ReportProgress(long current, long total)\n        {\n            if (current % 1000 == 0)\n            {\n                var percentage = (double)current / total * 100;\n                Console.WriteLine($"\uC9C4\uD589\uB960: {percentage:F1}%");\n            }\n        }\n    }\n}\n'})}),"\n",(0,a.jsx)(e.h3,{id:"2-wpfwinforms\uC5D0\uC11C-\uC0AC\uC6A9\uD558\uB294-\uBC29\uBC95",children:"2. WPF/WinForms\uC5D0\uC11C \uC0AC\uC6A9\uD558\uB294 \uBC29\uBC95"}),"\n",(0,a.jsx)(e.p,{children:"\uB2E4\uC74C\uC740 WPF \uC560\uD50C\uB9AC\uCF00\uC774\uC158\uC5D0\uC11C \uC548\uC804\uD55C \uBCD1\uB82C \uCC98\uB9AC\uB97C \uAD6C\uD604\uD558\uB294 \uBC29\uBC95\uC785\uB2C8\uB2E4:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:'public partial class MainWindow : Window\n{\n    private CancellationTokenSource _cancellationTokenSource;\n    \n    private async void StartButton_Click(object sender, RoutedEventArgs e)\n    {\n        try\n        {\n            StartButton.IsEnabled = false;\n            CancelButton.IsEnabled = true;\n            \n            _cancellationTokenSource = new CancellationTokenSource();\n            var processor = new SafeParallelProcessor();\n            \n            // UI \uC2A4\uB808\uB4DC\uB97C \uCC28\uB2E8\uD558\uC9C0 \uC54A\uACE0 \uBC31\uADF8\uB77C\uC6B4\uB4DC\uC5D0\uC11C \uC2E4\uD589\n            await processor.ProcessDataAsync(1000000, _cancellationTokenSource.Token)\n                          .ConfigureAwait(false);\n                          \n            MessageBox.Show("\uC791\uC5C5\uC774 \uC644\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4!");\n        }\n        catch (OperationCanceledException)\n        {\n            MessageBox.Show("\uC791\uC5C5\uC774 \uCDE8\uC18C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.");\n        }\n        catch (Exception ex)\n        {\n            MessageBox.Show($"\uC624\uB958 \uBC1C\uC0DD: {ex.Message}");\n        }\n        finally\n        {\n            StartButton.IsEnabled = true;\n            CancelButton.IsEnabled = false;\n            _cancellationTokenSource?.Dispose();\n        }\n    }\n    \n    private void CancelButton_Click(object sender, RoutedEventArgs e)\n    {\n        _cancellationTokenSource?.Cancel();\n    }\n}\n'})}),"\n",(0,a.jsx)(e.h3,{id:"3-\uC9C4\uD589\uB960-\uBCF4\uACE0\uAC00-\uD3EC\uD568\uB41C-\uACE0\uAE09-\uBC84\uC804",children:"3. \uC9C4\uD589\uB960 \uBCF4\uACE0\uAC00 \uD3EC\uD568\uB41C \uACE0\uAE09 \uBC84\uC804"}),"\n",(0,a.jsx)(e.p,{children:"\uC0AC\uC6A9\uC790 \uACBD\uD5D8\uC744 \uD5A5\uC0C1\uC2DC\uD0A4\uAE30 \uC704\uD574 \uC9C4\uD589\uB960 \uBCF4\uACE0 \uAE30\uB2A5\uC744 \uCD94\uAC00\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4."}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:'public class AdvancedParallelProcessor\n{\n    public async Task ProcessDataWithProgressAsync(\n        long itemCount, \n        IProgress<ProgressReport> progress = null,\n        CancellationToken cancellationToken = default)\n    {\n        const int batchSize = 1000;\n        var partitioner = Partitioner.Create(0, itemCount, batchSize);\n        var processedCount = 0L;\n        \n        var parallelOptions = new ParallelOptions\n        {\n            CancellationToken = cancellationToken,\n            MaxDegreeOfParallelism = Environment.ProcessorCount\n        };\n\n        try\n        {\n            await Task.Run(() =>\n            {\n                Parallel.ForEach(partitioner, parallelOptions, (range, state) =>\n                {\n                    for (long i = range.Item1; i < range.Item2; i++)\n                    {\n                        cancellationToken.ThrowIfCancellationRequested();\n                        \n                        ProcessSingleItem(i);\n                        \n                        // \uC2A4\uB808\uB4DC \uC548\uC804\uD55C \uCE74\uC6B4\uD130 \uC99D\uAC00\n                        var current = Interlocked.Increment(ref processedCount);\n                        \n                        // \uC9C4\uD589\uB960 \uBCF4\uACE0 (\uB108\uBB34 \uC790\uC8FC \uD638\uCD9C\uD558\uC9C0 \uC54A\uB3C4\uB85D \uC870\uC808)\n                        if (current % 100 == 0 || current == itemCount)\n                        {\n                            var percentage = (double)current / itemCount * 100;\n                            progress?.Report(new ProgressReport\n                            {\n                                Current = current,\n                                Total = itemCount,\n                                Percentage = percentage,\n                                Message = $"\uCC98\uB9AC \uC911... ({current:N0}/{itemCount:N0})"\n                            });\n                        }\n                    }\n                });\n            }, cancellationToken);\n        }\n        catch (OperationCanceledException)\n        {\n            progress?.Report(new ProgressReport\n            {\n                Current = processedCount,\n                Total = itemCount,\n                Percentage = (double)processedCount / itemCount * 100,\n                Message = "\uC791\uC5C5\uC774 \uCDE8\uC18C\uB418\uC5C8\uC2B5\uB2C8\uB2E4."\n            });\n            throw;\n        }\n    }\n    \n    private void ProcessSingleItem(long index)\n    {\n        // \uC2E4\uC81C \uC791\uC5C5 \uB85C\uC9C1\n        Thread.Sleep(1); // \uC2DC\uBBAC\uB808\uC774\uC158\n    }\n}\n\npublic class ProgressReport\n{\n    public long Current { get; set; }\n    public long Total { get; set; }\n    public double Percentage { get; set; }\n    public string Message { get; set; }\n}\n'})}),"\n",(0,a.jsx)(e.h3,{id:"4-\uC0AC\uC6A9-\uC608\uC81C-\uCF58\uC194-\uC560\uD50C\uB9AC\uCF00\uC774\uC158",children:"4. \uC0AC\uC6A9 \uC608\uC81C (\uCF58\uC194 \uC560\uD50C\uB9AC\uCF00\uC774\uC158)"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:'class Program\n{\n    static async Task Main(string[] args)\n    {\n        Console.WriteLine("\uBCD1\uB82C \uCC98\uB9AC \uC2DC\uC791 (\uC544\uBB34 \uD0A4\uB098 \uB204\uB974\uBA74 \uCDE8\uC18C)");\n        \n        using var cts = new CancellationTokenSource();\n        \n        // \uD0A4 \uC785\uB825 \uAC10\uC9C0\uB97C \uC704\uD55C \uBC31\uADF8\uB77C\uC6B4\uB4DC \uD0DC\uC2A4\uD06C\n        var keyTask = Task.Run(() =>\n        {\n            Console.ReadKey();\n            cts.Cancel();\n        });\n        \n        // \uC9C4\uD589\uB960 \uBCF4\uACE0 \uD578\uB4E4\uB7EC\n        var progress = new Progress<ProgressReport>(report =>\n        {\n            Console.WriteLine($"\\r{report.Message} ({report.Percentage:F1}%)");\n        });\n        \n        try\n        {\n            var processor = new AdvancedParallelProcessor();\n            await processor.ProcessDataWithProgressAsync(\n                itemCount: 100000,\n                progress: progress,\n                cancellationToken: cts.Token);\n                \n            Console.WriteLine("\\n\uC791\uC5C5\uC774 \uC644\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4!");\n        }\n        catch (OperationCanceledException)\n        {\n            Console.WriteLine("\\n\uC791\uC5C5\uC774 \uCDE8\uC18C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.");\n        }\n        \n        Console.WriteLine("\uC544\uBB34 \uD0A4\uB098 \uB204\uB974\uBA74 \uC885\uB8CC\uD569\uB2C8\uB2E4.");\n        Console.ReadKey();\n    }\n}\n'})}),"\n",(0,a.jsx)(e.h2,{id:"-\uC131\uB2A5-\uCD5C\uC801\uD654-\uD301",children:"\uD83D\uDD27 \uC131\uB2A5 \uCD5C\uC801\uD654 \uD301"}),"\n",(0,a.jsx)(e.p,{children:"\uC801\uC808\uD55C \uBCD1\uB82C\uB3C4\uC640 \uBC30\uCE58 \uD06C\uAE30 \uC124\uC815\uC73C\uB85C \uCD5C\uC801\uC758 \uC131\uB2A5\uC744 \uC5BB\uC744 \uC218 \uC788\uC2B5\uB2C8\uB2E4."}),"\n",(0,a.jsx)(e.h3,{id:"1-\uC801\uC808\uD55C-\uBCD1\uB82C\uB3C4-\uC124\uC815",children:"1. \uC801\uC808\uD55C \uBCD1\uB82C\uB3C4 \uC124\uC815"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:"var parallelOptions = new ParallelOptions\n{\n    // CPU \uC9D1\uC57D\uC801 \uC791\uC5C5: \uD504\uB85C\uC138\uC11C \uC218\uC640 \uB3D9\uC77C\n    MaxDegreeOfParallelism = Environment.ProcessorCount,\n    \n    // I/O \uC9D1\uC57D\uC801 \uC791\uC5C5: \uB354 \uB192\uC740 \uAC12 \uC0AC\uC6A9 \uAC00\uB2A5\n    // MaxDegreeOfParallelism = Environment.ProcessorCount * 2,\n    \n    CancellationToken = cancellationToken\n};\n"})}),"\n",(0,a.jsx)(e.h3,{id:"2-\uC801\uC808\uD55C-\uBC30\uCE58-\uD06C\uAE30-\uC120\uD0DD",children:"2. \uC801\uC808\uD55C \uBC30\uCE58 \uD06C\uAE30 \uC120\uD0DD"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:"// \uC791\uC740 \uC791\uC5C5: \uD070 \uBC30\uCE58 \uD06C\uAE30\nvar partitioner = Partitioner.Create(0, itemCount, 10000);\n\n// \uD070 \uC791\uC5C5: \uC791\uC740 \uBC30\uCE58 \uD06C\uAE30\nvar partitioner = Partitioner.Create(0, itemCount, 100);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"3-\uBA54\uBAA8\uB9AC-\uC0AC\uC6A9\uB7C9-\uCD5C\uC801\uD654",children:"3. \uBA54\uBAA8\uB9AC \uC0AC\uC6A9\uB7C9 \uCD5C\uC801\uD654"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-csharp",children:"// \uB300\uC6A9\uB7C9 \uB370\uC774\uD130 \uCC98\uB9AC \uC2DC \uC2A4\uD2B8\uB9AC\uBC0D \uBC29\uC2DD \uC0AC\uC6A9\npublic async IAsyncEnumerable<TResult> ProcessLargeDataStreamAsync<TResult>(\n    IAsyncEnumerable<TInput> source,\n    [EnumeratorCancellation] CancellationToken cancellationToken = default)\n{\n    await foreach (var batch in source.Buffer(1000).WithCancellation(cancellationToken))\n    {\n        var results = new ConcurrentBag<TResult>();\n        \n        Parallel.ForEach(batch, new ParallelOptions \n        { \n            CancellationToken = cancellationToken \n        }, item =>\n        {\n            cancellationToken.ThrowIfCancellationRequested();\n            var result = ProcessItem(item);\n            results.Add(result);\n        });\n        \n        foreach (var result in results)\n        {\n            yield return result;\n        }\n    }\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"-\uCD94\uAC00-\uD559\uC2B5-\uC790\uB8CC",children:"\uD83D\uDCDA \uCD94\uAC00 \uD559\uC2B5 \uC790\uB8CC"}),"\n",(0,a.jsx)(e.p,{children:"\uB2E4\uC74C \uC790\uB8CC\uB4E4\uC744 \uD1B5\uD574 \uB354 \uAE4A\uC774 \uC788\uB294 \uD559\uC2B5\uC744 \uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4."}),"\n",(0,a.jsx)(e.h3,{id:"\uAD8C\uC7A5-\uC77D\uAE30-\uC790\uB8CC",children:"\uAD8C\uC7A5 \uC77D\uAE30 \uC790\uB8CC:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/",children:"Microsoft Docs - Task Parallel Library"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/threading/cancellation-in-managed-threads",children:"Microsoft Docs - Cancellation in Managed Threads"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/archive/msdn-magazine/2013/march/async-await-best-practices-in-asynchronous-programming",children:"Stephen Cleary - Async/Await Best Practices"})}),"\n"]}),"\n",(0,a.jsx)(e.h3,{id:"\uAD00\uB828-\uD328\uD134",children:"\uAD00\uB828 \uD328\uD134:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Producer-Consumer Pattern"}),": \uB300\uC6A9\uB7C9 \uB370\uC774\uD130 \uC2A4\uD2B8\uB9AC\uBC0D"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Pipeline Pattern"}),": \uB2E8\uACC4\uBCC4 \uB370\uC774\uD130 \uCC98\uB9AC"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Actor Model"}),": \uBA54\uC2DC\uC9C0 \uAE30\uBC18 \uBCD1\uB82C \uCC98\uB9AC"]}),"\n"]}),"\n",(0,a.jsx)(e.h2,{id:"-\uACB0\uB860",children:"\uD83C\uDFAF \uACB0\uB860"}),"\n",(0,a.jsx)(e.h3,{id:"\uD575\uC2EC-\uC694\uC57D",children:"\uD575\uC2EC \uC694\uC57D"}),"\n",(0,a.jsx)(e.p,{children:"\uD604\uB300\uC801\uC778 C# \uAC1C\uBC1C\uC5D0\uC11C\uB294:"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Thread.Abort() \uC0AC\uC6A9 \uAE08\uC9C0"}),": \uC548\uC804\uD558\uC9C0 \uC54A\uACE0 .NET Core\uC5D0\uC11C \uC9C0\uC6D0\uB418\uC9C0 \uC54A\uC74C"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"CancellationToken \uD65C\uC6A9"}),": \uC548\uC804\uD558\uACE0 \uC608\uCE21 \uAC00\uB2A5\uD55C \uC791\uC5C5 \uC911\uB2E8"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"Task \uAE30\uBC18 \uBE44\uB3D9\uAE30 \uD328\uD134"}),": Thread\uBCF4\uB2E4 \uD6A8\uC728\uC801\uC774\uACE0 \uAD00\uB9AC\uD558\uAE30 \uC26C\uC6C0"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"\uC801\uC808\uD55C \uBCD1\uB82C\uB3C4 \uC124\uC815"}),": \uC131\uB2A5\uACFC \uB9AC\uC18C\uC2A4 \uC0AC\uC6A9\uB7C9\uC758 \uADE0\uD615"]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.strong,{children:"\uC9C4\uD589\uB960 \uBCF4\uACE0"}),": \uC0AC\uC6A9\uC790 \uACBD\uD5D8 \uD5A5\uC0C1"]}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"\uC774\uB7EC\uD55C \uD328\uD134\uC744 \uB530\uB974\uBA74 \uC548\uC804\uD558\uACE0 \uD6A8\uC728\uC801\uC778 \uBCD1\uB82C \uCC98\uB9AC \uC560\uD50C\uB9AC\uCF00\uC774\uC158\uC744 \uAC1C\uBC1C\uD560 \uC218 \uC788\uC2B5\uB2C8\uB2E4."}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"\uCC38\uACE0 \uC790\uB8CC:"})}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/",children:"Microsoft Docs - Parallel Programming"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://blog.stephencleary.com/",children:"Stephen Cleary's Blog"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"http://www.albahari.com/threading/",children:"Threading in C# by Joe Albahari"})}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,t.a)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}},65:function(n,e,r){r.d(e,{Z:function(){return s},a:function(){return o}});var l=r(7294);let a={},t=l.createContext(a);function o(n){let e=l.useContext(t);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:o(n.components),l.createElement(t.Provider,{value:e},n.children)}},1642:function(n){n.exports=JSON.parse('{"permalink":"/blog/csharp-thread-parallel-foreach-cancellation","source":"@site/blog/2017-01-09-post/index.md","title":"C#\uC5D0\uC11C Thread\uC640 Parallel.ForEach \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uB294 \uBC29\uBC95","description":"C#\uC5D0\uC11C Thread \uB0B4\uBD80\uC758 Parallel.ForEach \uC791\uC5C5\uC744 \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uB294 \uBC29\uBC95\uACFC \uD604\uB300\uC801\uC778 \uBE44\uB3D9\uAE30 \uD328\uD134\uC744 \uC18C\uAC1C\uD569\uB2C8\uB2E4.","date":"2017-01-09T00:00:00.000Z","tags":[{"inline":true,"label":"dotnet","permalink":"/blog/tags/dotnet"},{"inline":true,"label":"csharp","permalink":"/blog/tags/csharp"},{"inline":true,"label":"threading","permalink":"/blog/tags/threading"},{"inline":true,"label":"parallel","permalink":"/blog/tags/parallel"}],"readingTime":10.1,"hasTruncateMarker":true,"authors":[{"name":"Jeongyong Park","title":"\uC30D\uD314\uB144\uC0DD \uAC1C\uBC1C\uC790","url":"https://github.com/jeongyong-park","email":"kladess@gmail.com","socials":{"x":"https://x.com/chisquare88","github":"https://github.com/jeongyong-park"},"imageURL":"https://github.com/jeongyong-park.png","key":"jypark","page":null}],"frontMatter":{"title":"C#\uC5D0\uC11C Thread\uC640 Parallel.ForEach \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uB294 \uBC29\uBC95","date":"2017-01-09","description":"C#\uC5D0\uC11C Thread \uB0B4\uBD80\uC758 Parallel.ForEach \uC791\uC5C5\uC744 \uC548\uC804\uD558\uAC8C \uC911\uB2E8\uD558\uB294 \uBC29\uBC95\uACFC \uD604\uB300\uC801\uC778 \uBE44\uB3D9\uAE30 \uD328\uD134\uC744 \uC18C\uAC1C\uD569\uB2C8\uB2E4.","authors":["jypark"],"tags":["dotnet","csharp","threading","parallel"],"image":"csharp.png","slug":"csharp-thread-parallel-foreach-cancellation","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Docker\uB85C GDAL \uAC04\uD3B8\uD558\uAC8C \uC0AC\uC6A9\uD558\uAE30","permalink":"/blog/docker-gdal-geospatial-data-processing"}}')}}]);