"use strict";(self.webpackChunkjeongyong_park_github_io=self.webpackChunkjeongyong_park_github_io||[]).push([[9347],{5482:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>i,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var a=r(6840),l=r(4848),t=r(8453);const o={title:"C#\uc5d0\uc11c Thread\uc640 Parallel.ForEach \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\ub294 \ubc29\ubc95",date:"2017-01-09",description:"C#\uc5d0\uc11c Thread \ub0b4\ubd80\uc758 Parallel.ForEach \uc791\uc5c5\uc744 \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\ub294 \ubc29\ubc95\uacfc \ud604\ub300\uc801\uc778 \ube44\ub3d9\uae30 \ud328\ud134\uc744 \uc18c\uac1c\ud569\ub2c8\ub2e4.",authors:["jypark"],tags:["dotnet","csharp","threading","parallel"],image:"csharp.png",slug:"csharp-thread-parallel-foreach-cancellation",hide_table_of_contents:!1},s=void 0,i={authorsImageUrls:[void 0]},c=[{value:"Thread.Abort()\ub97c \uc0ac\uc6a9\ud558\uba74 \uc548 \ub418\ub294 \uc774\uc720:",id:"threadabort\ub97c-\uc0ac\uc6a9\ud558\uba74-\uc548-\ub418\ub294-\uc774\uc720",level:3},{value:"\ud83c\udfaf \ud575\uc2ec \uac1c\ub150",id:"-\ud575\uc2ec-\uac1c\ub150",level:2},{value:"\ud83d\udcdd \ub808\uac70\uc2dc \ucf54\ub4dc (\ucc38\uace0\uc6a9 - \uc0ac\uc6a9 \uae08\uc9c0)",id:"-\ub808\uac70\uc2dc-\ucf54\ub4dc-\ucc38\uace0\uc6a9---\uc0ac\uc6a9-\uae08\uc9c0",level:2},{value:"\u2705 \ud604\ub300\uc801\uc774\uace0 \uc548\uc804\ud55c \ubc29\ubc95",id:"-\ud604\ub300\uc801\uc774\uace0-\uc548\uc804\ud55c-\ubc29\ubc95",level:2},{value:"1. CancellationToken\uc744 \uc0ac\uc6a9\ud55c \uc548\uc804\ud55c \uc911\ub2e8",id:"1-cancellationtoken\uc744-\uc0ac\uc6a9\ud55c-\uc548\uc804\ud55c-\uc911\ub2e8",level:3},{value:"2. WPF/WinForms\uc5d0\uc11c \uc0ac\uc6a9\ud558\ub294 \ubc29\ubc95",id:"2-wpfwinforms\uc5d0\uc11c-\uc0ac\uc6a9\ud558\ub294-\ubc29\ubc95",level:3},{value:"3. \uc9c4\ud589\ub960 \ubcf4\uace0\uac00 \ud3ec\ud568\ub41c \uace0\uae09 \ubc84\uc804",id:"3-\uc9c4\ud589\ub960-\ubcf4\uace0\uac00-\ud3ec\ud568\ub41c-\uace0\uae09-\ubc84\uc804",level:3},{value:"4. \uc0ac\uc6a9 \uc608\uc81c (\ucf58\uc194 \uc560\ud50c\ub9ac\ucf00\uc774\uc158)",id:"4-\uc0ac\uc6a9-\uc608\uc81c-\ucf58\uc194-\uc560\ud50c\ub9ac\ucf00\uc774\uc158",level:3},{value:"\ud83d\udd27 \uc131\ub2a5 \ucd5c\uc801\ud654 \ud301",id:"-\uc131\ub2a5-\ucd5c\uc801\ud654-\ud301",level:2},{value:"1. \uc801\uc808\ud55c \ubcd1\ub82c\ub3c4 \uc124\uc815",id:"1-\uc801\uc808\ud55c-\ubcd1\ub82c\ub3c4-\uc124\uc815",level:3},{value:"2. \uc801\uc808\ud55c \ubc30\uce58 \ud06c\uae30 \uc120\ud0dd",id:"2-\uc801\uc808\ud55c-\ubc30\uce58-\ud06c\uae30-\uc120\ud0dd",level:3},{value:"3. \uba54\ubaa8\ub9ac \uc0ac\uc6a9\ub7c9 \ucd5c\uc801\ud654",id:"3-\uba54\ubaa8\ub9ac-\uc0ac\uc6a9\ub7c9-\ucd5c\uc801\ud654",level:3},{value:"\ud83d\udcda \ucd94\uac00 \ud559\uc2b5 \uc790\ub8cc",id:"-\ucd94\uac00-\ud559\uc2b5-\uc790\ub8cc",level:2},{value:"\uad8c\uc7a5 \uc77d\uae30 \uc790\ub8cc:",id:"\uad8c\uc7a5-\uc77d\uae30-\uc790\ub8cc",level:3},{value:"\uad00\ub828 \ud328\ud134:",id:"\uad00\ub828-\ud328\ud134",level:3},{value:"\ud83c\udfaf \uacb0\ub860",id:"-\uacb0\ub860",level:2},{value:"\ud575\uc2ec \uc694\uc57d",id:"\ud575\uc2ec-\uc694\uc57d",level:3}];function d(n){const e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...n.components},{Details:r}=e;return r||function(n,e){throw new Error("Expected "+(e?"component":"object")+" `"+n+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.p,{children:"GUI \ud658\uacbd\uc5d0\uc11c \ubc84\ud2bc \ud074\ub9ad\uacfc \uac19\uc740 \uc774\ubca4\ud2b8\ub85c \uc2dc\uac04\uc774 \uc624\ub798 \uac78\ub9ac\ub294 \uc791\uc5c5\uc744 \uc2e4\ud589\ud560 \ub54c, UI \uc2a4\ub808\ub4dc\uc640 \ubd84\ub9ac\ud558\uc5ec \uac1c\ubc1c\ud558\ub294 \uac83\uc740 C#\ubfd0\ub9cc \uc544\ub2c8\ub77c \ubaa8\ub4e0 GUI \ud504\ub808\uc784\uc6cc\ud06c\uc5d0\uc11c \uae30\ubcf8\uc801\uc778 \ud328\ud134\uc785\ub2c8\ub2e4."}),"\n",(0,l.jsx)(e.p,{children:'\uc2dc\uac04\uc774 \uc624\ub798 \uac78\ub9ac\ub294 \uc791\uc5c5\uc744 \ub354\uc6b1 \ube60\ub974\uac8c \ucc98\ub9ac\ud558\uace0 \uc2f6\ub2e4\uba74 \ubcd1\ub82c \ucc98\ub9ac\uac00 \uac00\uc7a5 \ud6a8\uacfc\uc801\uc778 \ubc29\ubc95 \uc911 \ud558\ub098\uc785\ub2c8\ub2e4. \ud558\uc9c0\ub9cc "\uc791\uc5c5\uc744 \ub3c4\uc911\uc5d0 \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\uace0 \uc2f6\ub2e4"\ub294 \uc694\uad6c\uc0ac\ud56d\uc774 \uc0dd\uae30\uba74\uc11c \ubcf5\uc7a1\ud55c \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud569\ub2c8\ub2e4.'}),"\n",(0,l.jsxs)(e.blockquote,{children:["\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"TL;DR"}),": Thread.Abort()\ub294 \uc704\ud5d8\ud558\ubbc0\ub85c \uc0ac\uc6a9\ud558\uc9c0 \ub9c8\uc138\uc694. \ub300\uc2e0 CancellationToken\uacfc Task \uae30\ubc18 \ube44\ub3d9\uae30 \ud328\ud134\uc744 \uc0ac\uc6a9\ud558\uc5ec \uc548\uc804\ud558\uac8c \ubcd1\ub82c \uc791\uc5c5\uc744 \uc911\ub2e8\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\uc774 \uae00\uc5d0\uc11c\ub294 Thread \ub0b4\ubd80\uc758 Parallel.ForEach \uc791\uc5c5\uc744 \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\ub294 \ubc29\ubc95\uacfc \ud604\ub300\uc801\uc778 \ube44\ub3d9\uae30 \ud328\ud134\uc744 \uc18c\uac1c\ud569\ub2c8\ub2e4."}),"\n",(0,l.jsxs)(e.admonition,{title:"Thread.Abort() \uc0ac\uc6a9 \uae08\uc9c0",type:"danger",children:[(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"\uc911\uc694"}),": \uc774 \uae00\uc758 \uc6d0\ubcf8 \ucf54\ub4dc\ub294 2017\ub144\uc5d0 \uc791\uc131\ub418\uc5c8\uc73c\uba70, ",(0,l.jsx)(e.code,{children:"Thread.Abort()"})," \uc0ac\uc6a9\uc744 \ud3ec\ud568\ud558\uace0 \uc788\uc2b5\ub2c8\ub2e4."]}),(0,l.jsxs)(e.p,{children:["\uc774 \ubc29\ubc95\uc740 \ud604\uc7ac ",(0,l.jsx)(e.strong,{children:"\uad8c\uc7a5\ub418\uc9c0 \uc54a\uc73c\uba70"}),", .NET Core/.NET 5+ \uc5d0\uc11c\ub294 ",(0,l.jsx)(e.strong,{children:"\uc9c0\uc6d0\ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4"}),"."]}),(0,l.jsxs)(e.p,{children:["\uc774 \uae00\uc5d0\uc11c\ub294 ",(0,l.jsx)(e.strong,{children:"CancellationToken"}),"\uacfc ",(0,l.jsx)(e.strong,{children:"Task \uae30\ubc18 \ube44\ub3d9\uae30 \ud328\ud134"}),"\uc744 \uc0ac\uc6a9\ud55c \uc548\uc804\ud55c \ubc29\ubc95\uc744 \uc81c\uc2dc\ud569\ub2c8\ub2e4."]})]}),"\n",(0,l.jsx)(e.h3,{id:"threadabort\ub97c-\uc0ac\uc6a9\ud558\uba74-\uc548-\ub418\ub294-\uc774\uc720",children:"Thread.Abort()\ub97c \uc0ac\uc6a9\ud558\uba74 \uc548 \ub418\ub294 \uc774\uc720:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\ub370\uc774\ud130 \uc190\uc0c1"}),": \uc791\uc5c5 \uc911\uc778 \ub370\uc774\ud130\uac00 \ubd88\uc644\uc804\ud55c \uc0c1\ud0dc\ub85c \ub0a8\uc744 \uc218 \uc788\uc74c"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\ub9ac\uc18c\uc2a4 \ub204\uc218"}),": \ud30c\uc77c \ud578\ub4e4, \ub124\ud2b8\uc6cc\ud06c \uc5f0\uacb0 \ub4f1\uc774 \uc81c\ub300\ub85c \ud574\uc81c\ub418\uc9c0 \uc54a\uc744 \uc218 \uc788\uc74c"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\uc608\uce21 \ubd88\uac00\ub2a5\ud55c \ub3d9\uc791"}),": \uc5b8\uc81c \uc5b4\ub514\uc11c \uc911\ub2e8\ub420\uc9c0 \uc608\uce21\ud560 \uc218 \uc5c6\uc74c"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:".NET Core \ubbf8\uc9c0\uc6d0"}),": .NET Core/.NET 5+ \uc5d0\uc11c\ub294 ",(0,l.jsx)(e.code,{children:"PlatformNotSupportedException"})," \ubc1c\uc0dd"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"-\ud575\uc2ec-\uac1c\ub150",children:"\ud83c\udfaf \ud575\uc2ec \uac1c\ub150"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"CancellationToken"}),": .NET\uc5d0\uc11c \uad8c\uc7a5\ud558\ub294 \uc548\uc804\ud55c \uc791\uc5c5 \uc911\ub2e8 \uba54\ucee4\ub2c8\uc998"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Task"}),": Thread\ubcf4\ub2e4 \ud604\ub300\uc801\uc774\uace0 \uc548\uc804\ud55c \ube44\ub3d9\uae30 \uc791\uc5c5 \ub2e8\uc704"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Parallel.ForEach"}),": CPU \uc9d1\uc57d\uc801 \uc791\uc5c5\uc758 \ubcd1\ub82c \ucc98\ub9ac"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"ConfigureAwait"}),": UI \uc2a4\ub808\ub4dc \ub370\ub4dc\ub77d \ubc29\uc9c0"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"-\ub808\uac70\uc2dc-\ucf54\ub4dc-\ucc38\uace0\uc6a9---\uc0ac\uc6a9-\uae08\uc9c0",children:"\ud83d\udcdd \ub808\uac70\uc2dc \ucf54\ub4dc (\ucc38\uace0\uc6a9 - \uc0ac\uc6a9 \uae08\uc9c0)"}),"\n",(0,l.jsxs)(e.p,{children:["\ub2e4\uc74c\uc740 \uc6d0\ubcf8 \uae00\uc758 \ucf54\ub4dc\uc785\ub2c8\ub2e4. ",(0,l.jsx)(e.strong,{children:"\uc2e4\uc81c \ud504\ub85c\uc81d\ud2b8\uc5d0\uc11c\ub294 \uc0ac\uc6a9\ud558\uc9c0 \ub9c8\uc138\uc694"}),":"]}),"\n",(0,l.jsxs)(r,{children:[(0,l.jsx)("summary",{children:"\ub808\uac70\uc2dc \ucf54\ub4dc \ubcf4\uae30 (Thread.Abort \uc0ac\uc6a9 - \uad8c\uc7a5\ud558\uc9c0 \uc54a\uc74c)"}),(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:'// \u274c \uc798\ubabb\ub41c \ubc29\ubc95 - Thread.Abort() \uc0ac\uc6a9\npublic class LegacyExample\n{\n    public void BadExample()\n    {\n        var canceler = new RulyCanceler();\n        var worker = new TestFilter(10000000);\n\n        Thread t = new Thread(() =>\n        {\n            try\n            {\n                worker.execute(canceler);\n            }\n            catch(OperationCanceledException)\n            {\n                Console.WriteLine("Canceled!");\n            }\n        });\n        \n        t.Start();\n        Console.ReadKey();\n        \n        // \u274c \uc704\ud5d8\ud55c \ubc29\ubc95\n        canceler.Cancel();\n        t.Abort();  // .NET Core\uc5d0\uc11c \uc9c0\uc6d0\ub418\uc9c0 \uc54a\uc74c\n        t.Join();\n    }\n}\n\npublic class RulyCanceler\n{\n    private readonly object _cancelLocker = new object();\n    private bool _cancelRequest;\n    \n    public bool IsCancellationRequested\n    {\n        get { lock (_cancelLocker) return _cancelRequest; }\n    }\n\n    public void Cancel() { lock (_cancelLocker) _cancelRequest = true; }\n\n    public void ThrowIfCancellationRequested()\n    {\n        if (IsCancellationRequested) throw new OperationCanceledException();\n    }\n}\n'})})]}),"\n",(0,l.jsx)(e.h2,{id:"-\ud604\ub300\uc801\uc774\uace0-\uc548\uc804\ud55c-\ubc29\ubc95",children:"\u2705 \ud604\ub300\uc801\uc774\uace0 \uc548\uc804\ud55c \ubc29\ubc95"}),"\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"CancellationToken"}),"\uc744 \uc0ac\uc6a9\ud558\uc5ec \uc548\uc804\ud558\uace0 \uc608\uce21 \uac00\ub2a5\ud55c \uc791\uc5c5 \uc911\ub2e8\uc744 \uad6c\ud604\ud558\uc138\uc694."]}),"\n",(0,l.jsx)(e.h3,{id:"1-cancellationtoken\uc744-\uc0ac\uc6a9\ud55c-\uc548\uc804\ud55c-\uc911\ub2e8",children:"1. CancellationToken\uc744 \uc0ac\uc6a9\ud55c \uc548\uc804\ud55c \uc911\ub2e8"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:'using System;\nusing System.Collections.Concurrent;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace ModernThreadingExample\n{\n    public class SafeParallelProcessor\n    {\n        public async Task ProcessDataAsync(long itemCount, CancellationToken cancellationToken = default)\n        {\n            const int batchSize = 1000;\n            var partitioner = Partitioner.Create(0, itemCount, batchSize);\n            \n            // ParallelOptions\ub97c \uc0ac\uc6a9\ud558\uc5ec CancellationToken \uc804\ub2ec\n            var parallelOptions = new ParallelOptions\n            {\n                CancellationToken = cancellationToken,\n                MaxDegreeOfParallelism = Environment.ProcessorCount\n            };\n\n            try\n            {\n                await Task.Run(() =>\n                {\n                    Parallel.ForEach(partitioner, parallelOptions, (range, state) =>\n                    {\n                        for (long i = range.Item1; i < range.Item2; i++)\n                        {\n                            // \uc8fc\uae30\uc801\uc73c\ub85c \ucde8\uc18c \uc694\uccad \ud655\uc778\n                            cancellationToken.ThrowIfCancellationRequested();\n                            \n                            // \uc2e4\uc81c \uc791\uc5c5 \uc218\ud589\n                            ProcessSingleItem(i);\n                            \n                            // \uc120\ud0dd\uc0ac\ud56d: \uc9c4\ud589\ub960 \ubcf4\uace0\n                            ReportProgress(i, itemCount);\n                        }\n                    });\n                }, cancellationToken);\n            }\n            catch (OperationCanceledException)\n            {\n                Console.WriteLine("\uc791\uc5c5\uc774 \ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4.");\n                throw; // \ud638\ucd9c\uc790\uc5d0\uac8c \ucde8\uc18c \uc0c1\ud0dc \uc804\ub2ec\n            }\n        }\n\n        private void ProcessSingleItem(long index)\n        {\n            // \uc2e4\uc81c \uc791\uc5c5 \ub85c\uc9c1\n            Console.WriteLine($"Processing item {index}");\n            \n            // \uc2dc\ubbac\ub808\uc774\uc158\uc744 \uc704\ud55c \uc9c0\uc5f0\n            Thread.Sleep(10);\n        }\n        \n        private void ReportProgress(long current, long total)\n        {\n            if (current % 1000 == 0)\n            {\n                var percentage = (double)current / total * 100;\n                Console.WriteLine($"\uc9c4\ud589\ub960: {percentage:F1}%");\n            }\n        }\n    }\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"2-wpfwinforms\uc5d0\uc11c-\uc0ac\uc6a9\ud558\ub294-\ubc29\ubc95",children:"2. WPF/WinForms\uc5d0\uc11c \uc0ac\uc6a9\ud558\ub294 \ubc29\ubc95"}),"\n",(0,l.jsx)(e.p,{children:"\ub2e4\uc74c\uc740 WPF \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc5d0\uc11c \uc548\uc804\ud55c \ubcd1\ub82c \ucc98\ub9ac\ub97c \uad6c\ud604\ud558\ub294 \ubc29\ubc95\uc785\ub2c8\ub2e4:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:'public partial class MainWindow : Window\n{\n    private CancellationTokenSource _cancellationTokenSource;\n    \n    private async void StartButton_Click(object sender, RoutedEventArgs e)\n    {\n        try\n        {\n            StartButton.IsEnabled = false;\n            CancelButton.IsEnabled = true;\n            \n            _cancellationTokenSource = new CancellationTokenSource();\n            var processor = new SafeParallelProcessor();\n            \n            // UI \uc2a4\ub808\ub4dc\ub97c \ucc28\ub2e8\ud558\uc9c0 \uc54a\uace0 \ubc31\uadf8\ub77c\uc6b4\ub4dc\uc5d0\uc11c \uc2e4\ud589\n            await processor.ProcessDataAsync(1000000, _cancellationTokenSource.Token)\n                          .ConfigureAwait(false);\n                          \n            MessageBox.Show("\uc791\uc5c5\uc774 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4!");\n        }\n        catch (OperationCanceledException)\n        {\n            MessageBox.Show("\uc791\uc5c5\uc774 \ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4.");\n        }\n        catch (Exception ex)\n        {\n            MessageBox.Show($"\uc624\ub958 \ubc1c\uc0dd: {ex.Message}");\n        }\n        finally\n        {\n            StartButton.IsEnabled = true;\n            CancelButton.IsEnabled = false;\n            _cancellationTokenSource?.Dispose();\n        }\n    }\n    \n    private void CancelButton_Click(object sender, RoutedEventArgs e)\n    {\n        _cancellationTokenSource?.Cancel();\n    }\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"3-\uc9c4\ud589\ub960-\ubcf4\uace0\uac00-\ud3ec\ud568\ub41c-\uace0\uae09-\ubc84\uc804",children:"3. \uc9c4\ud589\ub960 \ubcf4\uace0\uac00 \ud3ec\ud568\ub41c \uace0\uae09 \ubc84\uc804"}),"\n",(0,l.jsx)(e.p,{children:"\uc0ac\uc6a9\uc790 \uacbd\ud5d8\uc744 \ud5a5\uc0c1\uc2dc\ud0a4\uae30 \uc704\ud574 \uc9c4\ud589\ub960 \ubcf4\uace0 \uae30\ub2a5\uc744 \ucd94\uac00\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:'public class AdvancedParallelProcessor\n{\n    public async Task ProcessDataWithProgressAsync(\n        long itemCount, \n        IProgress<ProgressReport> progress = null,\n        CancellationToken cancellationToken = default)\n    {\n        const int batchSize = 1000;\n        var partitioner = Partitioner.Create(0, itemCount, batchSize);\n        var processedCount = 0L;\n        \n        var parallelOptions = new ParallelOptions\n        {\n            CancellationToken = cancellationToken,\n            MaxDegreeOfParallelism = Environment.ProcessorCount\n        };\n\n        try\n        {\n            await Task.Run(() =>\n            {\n                Parallel.ForEach(partitioner, parallelOptions, (range, state) =>\n                {\n                    for (long i = range.Item1; i < range.Item2; i++)\n                    {\n                        cancellationToken.ThrowIfCancellationRequested();\n                        \n                        ProcessSingleItem(i);\n                        \n                        // \uc2a4\ub808\ub4dc \uc548\uc804\ud55c \uce74\uc6b4\ud130 \uc99d\uac00\n                        var current = Interlocked.Increment(ref processedCount);\n                        \n                        // \uc9c4\ud589\ub960 \ubcf4\uace0 (\ub108\ubb34 \uc790\uc8fc \ud638\ucd9c\ud558\uc9c0 \uc54a\ub3c4\ub85d \uc870\uc808)\n                        if (current % 100 == 0 || current == itemCount)\n                        {\n                            var percentage = (double)current / itemCount * 100;\n                            progress?.Report(new ProgressReport\n                            {\n                                Current = current,\n                                Total = itemCount,\n                                Percentage = percentage,\n                                Message = $"\ucc98\ub9ac \uc911... ({current:N0}/{itemCount:N0})"\n                            });\n                        }\n                    }\n                });\n            }, cancellationToken);\n        }\n        catch (OperationCanceledException)\n        {\n            progress?.Report(new ProgressReport\n            {\n                Current = processedCount,\n                Total = itemCount,\n                Percentage = (double)processedCount / itemCount * 100,\n                Message = "\uc791\uc5c5\uc774 \ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4."\n            });\n            throw;\n        }\n    }\n    \n    private void ProcessSingleItem(long index)\n    {\n        // \uc2e4\uc81c \uc791\uc5c5 \ub85c\uc9c1\n        Thread.Sleep(1); // \uc2dc\ubbac\ub808\uc774\uc158\n    }\n}\n\npublic class ProgressReport\n{\n    public long Current { get; set; }\n    public long Total { get; set; }\n    public double Percentage { get; set; }\n    public string Message { get; set; }\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"4-\uc0ac\uc6a9-\uc608\uc81c-\ucf58\uc194-\uc560\ud50c\ub9ac\ucf00\uc774\uc158",children:"4. \uc0ac\uc6a9 \uc608\uc81c (\ucf58\uc194 \uc560\ud50c\ub9ac\ucf00\uc774\uc158)"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:'class Program\n{\n    static async Task Main(string[] args)\n    {\n        Console.WriteLine("\ubcd1\ub82c \ucc98\ub9ac \uc2dc\uc791 (\uc544\ubb34 \ud0a4\ub098 \ub204\ub974\uba74 \ucde8\uc18c)");\n        \n        using var cts = new CancellationTokenSource();\n        \n        // \ud0a4 \uc785\ub825 \uac10\uc9c0\ub97c \uc704\ud55c \ubc31\uadf8\ub77c\uc6b4\ub4dc \ud0dc\uc2a4\ud06c\n        var keyTask = Task.Run(() =>\n        {\n            Console.ReadKey();\n            cts.Cancel();\n        });\n        \n        // \uc9c4\ud589\ub960 \ubcf4\uace0 \ud578\ub4e4\ub7ec\n        var progress = new Progress<ProgressReport>(report =>\n        {\n            Console.WriteLine($"\\r{report.Message} ({report.Percentage:F1}%)");\n        });\n        \n        try\n        {\n            var processor = new AdvancedParallelProcessor();\n            await processor.ProcessDataWithProgressAsync(\n                itemCount: 100000,\n                progress: progress,\n                cancellationToken: cts.Token);\n                \n            Console.WriteLine("\\n\uc791\uc5c5\uc774 \uc644\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4!");\n        }\n        catch (OperationCanceledException)\n        {\n            Console.WriteLine("\\n\uc791\uc5c5\uc774 \ucde8\uc18c\ub418\uc5c8\uc2b5\ub2c8\ub2e4.");\n        }\n        \n        Console.WriteLine("\uc544\ubb34 \ud0a4\ub098 \ub204\ub974\uba74 \uc885\ub8cc\ud569\ub2c8\ub2e4.");\n        Console.ReadKey();\n    }\n}\n'})}),"\n",(0,l.jsx)(e.h2,{id:"-\uc131\ub2a5-\ucd5c\uc801\ud654-\ud301",children:"\ud83d\udd27 \uc131\ub2a5 \ucd5c\uc801\ud654 \ud301"}),"\n",(0,l.jsx)(e.p,{children:"\uc801\uc808\ud55c \ubcd1\ub82c\ub3c4\uc640 \ubc30\uce58 \ud06c\uae30 \uc124\uc815\uc73c\ub85c \ucd5c\uc801\uc758 \uc131\ub2a5\uc744 \uc5bb\uc744 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,l.jsx)(e.h3,{id:"1-\uc801\uc808\ud55c-\ubcd1\ub82c\ub3c4-\uc124\uc815",children:"1. \uc801\uc808\ud55c \ubcd1\ub82c\ub3c4 \uc124\uc815"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:"var parallelOptions = new ParallelOptions\n{\n    // CPU \uc9d1\uc57d\uc801 \uc791\uc5c5: \ud504\ub85c\uc138\uc11c \uc218\uc640 \ub3d9\uc77c\n    MaxDegreeOfParallelism = Environment.ProcessorCount,\n    \n    // I/O \uc9d1\uc57d\uc801 \uc791\uc5c5: \ub354 \ub192\uc740 \uac12 \uc0ac\uc6a9 \uac00\ub2a5\n    // MaxDegreeOfParallelism = Environment.ProcessorCount * 2,\n    \n    CancellationToken = cancellationToken\n};\n"})}),"\n",(0,l.jsx)(e.h3,{id:"2-\uc801\uc808\ud55c-\ubc30\uce58-\ud06c\uae30-\uc120\ud0dd",children:"2. \uc801\uc808\ud55c \ubc30\uce58 \ud06c\uae30 \uc120\ud0dd"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:"// \uc791\uc740 \uc791\uc5c5: \ud070 \ubc30\uce58 \ud06c\uae30\nvar partitioner = Partitioner.Create(0, itemCount, 10000);\n\n// \ud070 \uc791\uc5c5: \uc791\uc740 \ubc30\uce58 \ud06c\uae30\nvar partitioner = Partitioner.Create(0, itemCount, 100);\n"})}),"\n",(0,l.jsx)(e.h3,{id:"3-\uba54\ubaa8\ub9ac-\uc0ac\uc6a9\ub7c9-\ucd5c\uc801\ud654",children:"3. \uba54\ubaa8\ub9ac \uc0ac\uc6a9\ub7c9 \ucd5c\uc801\ud654"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-csharp",children:"// \ub300\uc6a9\ub7c9 \ub370\uc774\ud130 \ucc98\ub9ac \uc2dc \uc2a4\ud2b8\ub9ac\ubc0d \ubc29\uc2dd \uc0ac\uc6a9\npublic async IAsyncEnumerable<TResult> ProcessLargeDataStreamAsync<TResult>(\n    IAsyncEnumerable<TInput> source,\n    [EnumeratorCancellation] CancellationToken cancellationToken = default)\n{\n    await foreach (var batch in source.Buffer(1000).WithCancellation(cancellationToken))\n    {\n        var results = new ConcurrentBag<TResult>();\n        \n        Parallel.ForEach(batch, new ParallelOptions \n        { \n            CancellationToken = cancellationToken \n        }, item =>\n        {\n            cancellationToken.ThrowIfCancellationRequested();\n            var result = ProcessItem(item);\n            results.Add(result);\n        });\n        \n        foreach (var result in results)\n        {\n            yield return result;\n        }\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h2,{id:"-\ucd94\uac00-\ud559\uc2b5-\uc790\ub8cc",children:"\ud83d\udcda \ucd94\uac00 \ud559\uc2b5 \uc790\ub8cc"}),"\n",(0,l.jsx)(e.p,{children:"\ub2e4\uc74c \uc790\ub8cc\ub4e4\uc744 \ud1b5\ud574 \ub354 \uae4a\uc774 \uc788\ub294 \ud559\uc2b5\uc744 \ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,l.jsx)(e.h3,{id:"\uad8c\uc7a5-\uc77d\uae30-\uc790\ub8cc",children:"\uad8c\uc7a5 \uc77d\uae30 \uc790\ub8cc:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/",children:"Microsoft Docs - Task Parallel Library"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/threading/cancellation-in-managed-threads",children:"Microsoft Docs - Cancellation in Managed Threads"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/archive/msdn-magazine/2013/march/async-await-best-practices-in-asynchronous-programming",children:"Stephen Cleary - Async/Await Best Practices"})}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"\uad00\ub828-\ud328\ud134",children:"\uad00\ub828 \ud328\ud134:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Producer-Consumer Pattern"}),": \ub300\uc6a9\ub7c9 \ub370\uc774\ud130 \uc2a4\ud2b8\ub9ac\ubc0d"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Pipeline Pattern"}),": \ub2e8\uacc4\ubcc4 \ub370\uc774\ud130 \ucc98\ub9ac"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Actor Model"}),": \uba54\uc2dc\uc9c0 \uae30\ubc18 \ubcd1\ub82c \ucc98\ub9ac"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"-\uacb0\ub860",children:"\ud83c\udfaf \uacb0\ub860"}),"\n",(0,l.jsx)(e.h3,{id:"\ud575\uc2ec-\uc694\uc57d",children:"\ud575\uc2ec \uc694\uc57d"}),"\n",(0,l.jsx)(e.p,{children:"\ud604\ub300\uc801\uc778 C# \uac1c\ubc1c\uc5d0\uc11c\ub294:"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Thread.Abort() \uc0ac\uc6a9 \uae08\uc9c0"}),": \uc548\uc804\ud558\uc9c0 \uc54a\uace0 .NET Core\uc5d0\uc11c \uc9c0\uc6d0\ub418\uc9c0 \uc54a\uc74c"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"CancellationToken \ud65c\uc6a9"}),": \uc548\uc804\ud558\uace0 \uc608\uce21 \uac00\ub2a5\ud55c \uc791\uc5c5 \uc911\ub2e8"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"Task \uae30\ubc18 \ube44\ub3d9\uae30 \ud328\ud134"}),": Thread\ubcf4\ub2e4 \ud6a8\uc728\uc801\uc774\uace0 \uad00\ub9ac\ud558\uae30 \uc26c\uc6c0"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\uc801\uc808\ud55c \ubcd1\ub82c\ub3c4 \uc124\uc815"}),": \uc131\ub2a5\uacfc \ub9ac\uc18c\uc2a4 \uc0ac\uc6a9\ub7c9\uc758 \uade0\ud615"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.strong,{children:"\uc9c4\ud589\ub960 \ubcf4\uace0"}),": \uc0ac\uc6a9\uc790 \uacbd\ud5d8 \ud5a5\uc0c1"]}),"\n"]}),"\n",(0,l.jsx)(e.p,{children:"\uc774\ub7ec\ud55c \ud328\ud134\uc744 \ub530\ub974\uba74 \uc548\uc804\ud558\uace0 \ud6a8\uc728\uc801\uc778 \ubcd1\ub82c \ucc98\ub9ac \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc744 \uac1c\ubc1c\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\ucc38\uace0 \uc790\ub8cc:"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/",children:"Microsoft Docs - Parallel Programming"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://blog.stephencleary.com/",children:"Stephen Cleary's Blog"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"http://www.albahari.com/threading/",children:"Threading in C# by Joe Albahari"})}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(d,{...n})}):d(n)}},6840:n=>{n.exports=JSON.parse('{"permalink":"/blog/csharp-thread-parallel-foreach-cancellation","source":"@site/blog/2017-01-09-post/index.md","title":"C#\uc5d0\uc11c Thread\uc640 Parallel.ForEach \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\ub294 \ubc29\ubc95","description":"C#\uc5d0\uc11c Thread \ub0b4\ubd80\uc758 Parallel.ForEach \uc791\uc5c5\uc744 \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\ub294 \ubc29\ubc95\uacfc \ud604\ub300\uc801\uc778 \ube44\ub3d9\uae30 \ud328\ud134\uc744 \uc18c\uac1c\ud569\ub2c8\ub2e4.","date":"2017-01-09T00:00:00.000Z","tags":[{"inline":true,"label":"dotnet","permalink":"/blog/tags/dotnet"},{"inline":true,"label":"csharp","permalink":"/blog/tags/csharp"},{"inline":true,"label":"threading","permalink":"/blog/tags/threading"},{"inline":true,"label":"parallel","permalink":"/blog/tags/parallel"}],"readingTime":5.48,"hasTruncateMarker":true,"authors":[{"name":"Jeongyong Park","title":"\uc30d\ud314\ub144\uc0dd \uac1c\ubc1c\uc790","url":"https://github.com/jeongyong-park","email":"kladess@gmail.com","socials":{"x":"https://x.com/chisquare88","github":"https://github.com/jeongyong-park"},"imageURL":"https://github.com/jeongyong-park.png","key":"jypark","page":null}],"frontMatter":{"title":"C#\uc5d0\uc11c Thread\uc640 Parallel.ForEach \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\ub294 \ubc29\ubc95","date":"2017-01-09","description":"C#\uc5d0\uc11c Thread \ub0b4\ubd80\uc758 Parallel.ForEach \uc791\uc5c5\uc744 \uc548\uc804\ud558\uac8c \uc911\ub2e8\ud558\ub294 \ubc29\ubc95\uacfc \ud604\ub300\uc801\uc778 \ube44\ub3d9\uae30 \ud328\ud134\uc744 \uc18c\uac1c\ud569\ub2c8\ub2e4.","authors":["jypark"],"tags":["dotnet","csharp","threading","parallel"],"image":"csharp.png","slug":"csharp-thread-parallel-foreach-cancellation","hide_table_of_contents":false},"unlisted":false,"prevItem":{"title":"Docker\ub85c GDAL \uac04\ud3b8\ud558\uac8c \uc0ac\uc6a9\ud558\uae30","permalink":"/blog/docker-gdal-geospatial-data-processing"}}')},8453:(n,e,r)=>{r.d(e,{R:()=>o,x:()=>s});var a=r(6540);const l={},t=a.createContext(l);function o(n){const e=a.useContext(t);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:o(n.components),a.createElement(t.Provider,{value:e},n.children)}}}]);